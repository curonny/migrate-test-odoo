<odoo>
  <data>
    <!--
        Render a res.partner record to be added to the UBL xml document.
        -->
    <template id="export_ubl_invoice_partner">
      <cac:Party xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
        <cbc:WebsiteURI t-if="partner.website" t-out="partner.website"/>
        <cac:PartyName>
          <cbc:Name t-out="partner.name"/>
        </cac:PartyName>
        <cac:Language t-if="partner.lang">
          <cbc:LocaleCode t-out="partner.lang"/>
        </cac:Language>
        <cac:PostalAddress>
          <cbc:StreetName t-if="partner.street" t-out="partner.street"/>
          <cbc:AdditionalStreetName t-if="partner.street2" t-out="partner.street2"/>
          <cbc:CityName t-if="partner.city" t-out="partner.city"/>
          <cbc:PostalZone t-if="partner.zip" t-out="partner.zip"/>
          <cbc:CountrySubentity t-if="partner.state_id" t-out="partner.state_id.name"/>
          <cbc:CountrySubentityCode t-if="partner.state_id" t-out="partner.state_id.code"/>
          <cac:Country t-if="partner.country_id">
            <cbc:IdentificationCode t-out="partner.country_id.code"/>
            <cbc:Name t-out="partner.country_id.name"/>
          </cac:Country>
        </cac:PostalAddress>
        <cac:PartyTaxScheme t-if="partner.vat">
          <cbc:RegistrationName t-out="partner.name"/>
          <cbc:CompanyID t-out="partner.vat"/>
          <cac:TaxScheme>
            <cbc:ID schemeID="UN/ECE 5153" schemeAgencyID="6">VAT</cbc:ID>
          </cac:TaxScheme>
        </cac:PartyTaxScheme>
        <cac:Contact>
          <cbc:Name t-out="partner.name"/>
          <cbc:Telephone t-if="partner.phone" t-out="partner.phone"/>
          <cbc:ElectronicMail t-if="partner.email" t-out="partner.email"/>
        </cac:Contact>
      </cac:Party>
    </template>
    <!--
        Render an invoice's line to be added to the UBL xml document.
        -->
    <template id="export_ubl_invoice_line">
      <cac:InvoiceLine xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
        <cbc:ID t-out="line._origin.id"/>
        <cbc:Note t-if="line.discount">Discount (<t t-out="line.discount"/> %)</cbc:Note>
        <cbc:InvoicedQuantity t-out="line.quantity"/>
        <cbc:LineExtensionAmount t-att-currencyID="line.currency_id.name or invoice.currency_id.name" t-out="format_monetary(line.price_subtotal)"/>
        <cac:TaxTotal t-foreach="line.tax_ids.compute_all(line.price_unit, quantity=line.quantity, product=line.product_id, partner=invoice.partner_id)['taxes']" t-as="tax">
          <cbc:TaxAmount t-att-currencyID="line.currency_id.name or invoice.currency_id.name" t-out="format_monetary(tax['amount'])"/>
        </cac:TaxTotal>
        <cac:Item>
          <cbc:Description t-if="line.name" t-out="line.name.replace('\n', ', ')"/>
          <cbc:Name t-out="line.product_id.name"/>
          <cac:SellersItemIdentification t-if="line.product_id.default_code">
            <cbc:ID t-out="line.product_id.default_code"/>
          </cac:SellersItemIdentification>
        </cac:Item>
        <cac:Price>
          <cbc:PriceAmount t-att-currencyID="line.currency_id.name or invoice.currency_id.name" t-out="format_monetary(line.price_unit)"/>
        </cac:Price>
      </cac:InvoiceLine>
    </template>
    <!--
        Render an invoice to be added to the UBL xml document.
        -->
    <template id="export_ubl_invoice">
      <Invoice xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
        <cbc:UBLVersionID t-out="ubl_version"/>
        <cbc:ID t-out="invoice.name"/>
        <cbc:IssueDate t-out="invoice.invoice_date"/>
        <cbc:InvoiceTypeCode t-out="type_code"/>
        <cbc:Note t-out="invoice.narration"/>
        <cbc:DocumentCurrencyCode t-out="invoice.currency_id.name"/>
        <cac:AccountingSupplierParty t-call="account_edi_ubl.export_ubl_invoice_partner">
          <t t-set="partner" t-value="invoice.company_id.partner_id.commercial_partner_id"/>
        </cac:AccountingSupplierParty>
        <cac:AccountingCustomerParty t-call="account_edi_ubl.export_ubl_invoice_partner">
          <t t-set="partner" t-value="invoice.commercial_partner_id"/>
        </cac:AccountingCustomerParty>
        <cac:PaymentMeans>
          <cbc:PaymentMeansCode listID="UN/ECE 4461" t-out="payment_means_code"/>
          <cbc:PaymentDueDate t-out="invoice.invoice_date_due"/>
          <cbc:InstructionID t-out="invoice.payment_reference"/>
          <cac:PayeeFinancialAccount t-if="invoice.journal_id.bank_account_id">
            <cbc:ID schemeName="IBAN" t-out="invoice.journal_id.bank_account_id.acc_number"/>
            <cac:FinancialInstitutionBranch t-if="invoice.journal_id.bank_account_id.bank_bic">
              <cac:FinancialInstitution>
                <cbc:ID schemeName="BIC" t-out="invoice.journal_id.bank_account_id.bank_bic"/>
              </cac:FinancialInstitution>
            </cac:FinancialInstitutionBranch>
          </cac:PayeeFinancialAccount>
        </cac:PaymentMeans>
        <cac:PaymentTerms t-if="invoice.invoice_payment_term_id">
          <cbc:Note t-out="invoice.invoice_payment_term_id.name"/>
        </cac:PaymentTerms>
        <cac:TaxTotal t-if="not invoice.currency_id.is_zero(invoice.amount_tax)">
          <cbc:TaxAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_tax)"/>
        </cac:TaxTotal>
        <cac:LegalMonetaryTotal>
          <cbc:LineExtensionAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_untaxed)"/>
          <cbc:TaxExclusiveAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_untaxed)"/>
          <cbc:TaxInclusiveAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_total)"/>
          <cbc:PrepaidAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_total - invoice.amount_residual)"/>
          <cbc:PayableAmount t-att-currencyID="invoice.currency_id.name" t-out="format_monetary(invoice.amount_residual)"/>
        </cac:LegalMonetaryTotal>
        <t t-call="account_edi_ubl.export_ubl_invoice_line" t-foreach="invoice.invoice_line_ids" t-as="line"/>
      </Invoice>
    </template>
  </data>
</odoo>
